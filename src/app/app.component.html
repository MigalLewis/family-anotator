<div class="container py-3">
  <div class="d-flex align-items-center gap-3 mb-3">
    <h1 class="h4 m-0">{{ title }}</h1>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-primary" (click)="startPointMode()">Add pin</button>
      <button class="btn btn-outline-warning" (click)="startPolyMode()">Draw area</button>
      <button class="btn btn-outline-secondary" (click)="cancelDraw()">Stop drawing</button>
    </div>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-secondary" (click)="zoomOut()">−</button>
      <button class="btn btn-outline-secondary" (click)="resetView()">Reset</button>
      <button class="btn btn-outline-secondary" (click)="zoomIn()">＋</button>
    </div>
    <div class="ms-auto d-flex align-items-center gap-2">
      <button class="btn btn-sm btn-outline-success" (click)="exportJSON()">Export JSON</button>
      <label class="btn btn-sm btn-outline-dark m-0">
        Import JSON <input type="file" accept="application/json" (change)="importJSON($event)" hidden>
      </label>
    </div>
  </div>


  <div class="stage border rounded shadow-sm" #wrap (mousemove)="onMouseMove($event)" (click)="onCanvasClick($event)"
    (wheel)="onWheel($event)" (mousedown)="onDragStart($event)">


    <!-- Image -->
    <img #imgEl src="images/family.jpeg" alt="Family" (load)="onImageLoad()" draggable="false">


    <!-- SVG overlay (pins, polygons) -->
    <svg #svg xmlns="http://www.w3.org/2000/svg" class="overlay">
      <!-- Existing annotations -->
      <ng-container *ngFor="let a of annotations">
        <!-- Point pin -->
        <ng-container *ngIf="a.type === 'point'">
          <circle [attr.cx]="a.points[0].xPct * 100 + '%'" [attr.cy]="a.points[0].yPct * 100 + '%'" r="0.9%"
            [attr.fill]="a.color || '#2a4de3'" [attr.opacity]="hoverId() === a.id ? 1 : 0.85"></circle>
        </ng-container>


        <!-- Polygon -->
        <ng-container *ngIf="a.type === 'polygon'">
          <polygon [attr.points]="getDrawingPolygonPoints(a.points)" [attr.fill]="a.color || '#e67e22'" fill-opacity="0.18" [attr.stroke]="a.color || '#e67e22'"
            stroke-width="1.5" [attr.opacity]="hoverId() === a.id ? 1 : 0.75" />
        </ng-container>
      </ng-container>


      <!-- Live polygon drawing preview -->
      <polyline *ngIf="drawingPolygon.length"
        [attr.points]="getDrawingPolygonPoints(drawingPolygon)" stroke="#e67e22"
        stroke-width="1.5" fill="none" stroke-dasharray="4 4" />
    </svg>
  </div>


  <!-- List / edit panel -->
  <div class="mt-3">
    <h2 class="h6">People ({{ annotations.length }})</h2>
    <div class="row g-2">
      <div class="col-md-4" *ngFor="let a of annotations">
        <div class="card card-sm p-2 d-flex flex-row align-items-center justify-content-between">
          <div>
            <div class="fw-semibold">{{ a.name }}</div>
            <div class="text-muted small">{{ a.type }} · {{ a.createdAt | date:'short' }}</div>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" (click)="renameAnn(a)">Rename</button>
            <button class="btn btn-outline-danger" (click)="deleteAnn(a)">Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Tooltip -->
  <div class="tt" *ngIf="tooltip()" [style.left.px]="tooltip()!.x" [style.top.px]="tooltip()!.y">{{ tooltip()!.text }}
  </div>
</div>